

1. Preparation
----------------

Start a new terminal emulator window which should come up with a BASH shell
prompt. Set some environment variables, e.g.

    export day=160426
    export AI_SITE=SSO
    export AI_RAWDIR=./
    export AI_TMPDIR=/tmp

Load AIRTOOLS shell functions:

    . airfun.sh


2. Metadata files
-------------------

set.dat    - observations data file
camera.dat - telescope and camera data file
sites.dat  - observatory sites data file
refcat.dat - reference catalog meta data (DO NOT EDIT)

Templates of those metadata files are provided under the directory
/usr/local/share/airtools/

Some notes about the observations data file: Usually an observation of a single
target consists of multiple exposures - denoted as an image set. Each
set must have a line in the observations data file with the following fields
(separated by spaces):
- approx start time
- a short set name
- the target
- an image type letter: o=object d=dark/bias f=flat
- exposure time in seconds
- first image number (individual images have 4-digit numbers)
- last image number
- reference image number
- name of dark image (without extension)
- name of flat field image (without extension)


3. Basic image reduction
--------------------------

All basic reduction steps can be done by AIRTOOLS commands but this is not
covered in this short guide. Most users do have already their own pipeline
using other - more commonly used - software.
At the end you should have two stacked images: one centered on stars (hereafter
referred to as star stack) and another centered on the comet (called comet
stack).

It is required that those images have a linear response between collected
photons and measured counts (ADU). Moreover it is strongly advised to not
subtract any background (e.g. gradients) at this stage.


4. Converting FITS images
---------------------------

Most likely your stacked images are in FITS format. The AIRTOOLS software
natively operates on Netpbm image file formats (PGM, PPM). This has originally
been decided on to best suit programs from ImageMagick and Netpbm toolkits and
to handle DSLR images in first place.

The conversion of a single color FITS image is done by using the command line
program meftopnm:

    meftopnm <star_stack_fits>     >  <set>.pgm

In addition, FITS header data are extracted to an ASCII header file (required
for star stack only):

    meftopnm -a <star_stack_fits>  >  <set>.head

Currently, the file name of the star stack PGM/PPM image and associated ASCII
header file must start with the image set name as defined in set.dat.

Typically, a comet observation will result in a second image stack centered on
the comet. This image is converted similarly:

    meftopnm <comet_stack_fits>    >  <set>_cs.pgm


5. Image metadata
-------------------

The created ASCII header file should be checked for required keywords. There
is a template file /usr/local/share/airtools/example.head which can be used as
reference.

Additional information must be supplied:
- telescope identifier as defined in camera.dat
- approximate position angle of true celestial north (from top over left),
  if north is not at top of stacked images

Example command:

    set_header <set>.head AI_TELID=P300 AI_NPA=20

Comet observations must also include
- the file name of the related comet stack
- approximate length of star trails on comet stack in pixels (note: a more
  accurate modelling of the comet trail can be achieved by providing a text
  file containing dates of individual exposures)
- some ephemeral dates like comet coordinates and sky motion

Example commands:

    set_header <set>.head AI_COMST=<set>_cs.pgm AI_TRAIL=5
    get_mpcephem -w <set>


6. Comet photometry
---------------------

All tasks required for measuring the total coma brightness of comets
are implemented as analysis tasks in the SAOImage display GUI. It is started
by the command

    AIexamine <star_stack> <comet_stack> &

where <star_stack> and <comet_stack> must be replaced by the appropriate
image file names (either PGM or PPM format).
The AIRTOOLS tasks are now available from the "Analysis" menu (bottom entries).

The usual reduction pipeline involves the following steps:
- Astrometric calibration
- Background gradient removal
- PSF extraction
- Comet extraction
- Photometrc calibration

After finishing your image reduction, you may savely remove some temporary
files (name prefix x) from your working directory.


7. Sample data
----------------

Sample images of a comet observations are provided at
    https://github.com/ewelot/temp/raw/master/sample_160224.tar.gz
